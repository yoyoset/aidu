# Magic Link Implementation Plan (Zero-Input Config)

> **Objective**: Simplify Mobile App onboarding by replacing manual text entry with a single "Magic Link" generated by the PC Extension.

> [!CAUTION]
> **Critical Prerequisite**: Mobile App Data Isolation.
> Currently, the Mobile App stores all words in a single `aidu_vocab` key. Switching profiles via Magic Link will cause **Data Pollution** (mixing Profile A words with Profile B) if we don't fix storage first.
> **Requirement**: The implementation **MUST** first upgrade `mobile/app.js` to store data in `aidu_vocab_${profileId}` keys and switch data context when profile changes.

## 1. URL Schema Strategy
To keep the URL length manageable, we will use a base64-encoded JSON payload with Minified Keys.

**Query Parameter**: `conf`
**Payload Structure**:
```json
{
  "u": "https://aidu-sync.xxx.workers.dev",  // u = url
  "t": "my_secret_token",                   // t = token
  "p": "profile_123"                        // p = profile
}
```
**Example URL**:
`https://aidu-mobile.pages.dev/?conf=eyJ1IjoiaHR0cHM6Ly9...`

---

## 2. Mobile App Implementation (`mobile/app.js`)

### 2.1 Logic in `App.init()`
At the very beginning of initialization:
1.  Check `window.location.search` for `conf`.
2.  If found:
    *   **Decode**: `atob()` (Handle errors gracefully).
    *   **Validate**: Check for "u" and "t".
    *   **Save**: Map "u"->"url", "t"->"token", "p"->"profile" and save to `localStorage`.
    *   **Switch Context**: Call `App.loadProfileData(json.p)` to ensure `this.data` matches the new profile.
    *   **Clean Up**: Use `history.replaceState` to remove the query param.
    *   **Feedback**: Show Toast: "Auto-configured from Magic Link!".
    *   **Auto-Sync**: Trigger `this.sync()` automatically.

### Code Snippet (Draft)
```javascript
const params = new URLSearchParams(window.location.search);
if (params.has('conf')) {
    try {
        const json = JSON.parse(atob(params.get('conf')));
        if (json.u && json.t) {
            const newProfile = json.p || 'default';
            Store.saveSettings({ 
                url: json.u, 
                token: json.t, 
                profile: newProfile 
            });
            
            // CRITICAL: Reload Data Context
            this.currentProfile = newProfile;
            this.data = Store.getVocab(newProfile); // Updated Store method
            this.renderStats();

            window.history.replaceState({}, document.title, window.location.pathname);
            this.toast("Configuration Imported!");
            setTimeout(() => this.sync(), 500); // Trigger sync
        }
    } catch(e) { console.error("Magic Link Failed", e); }
}
```

### 2.2 Update `Store` Object (Prerequisite)
```javascript
const Store = {
    getSettings: () => JSON.parse(localStorage.getItem('aidu_settings') || '{}'),
    saveSettings: (s) => localStorage.setItem('aidu_settings', JSON.stringify(s)),
    // Schema Change: Support profileId
    getVocab: (profileId) => JSON.parse(localStorage.getItem(`aidu_vocab_${profileId}`) || '{}'),
    saveVocab: (v, profileId) => localStorage.setItem(`aidu_vocab_${profileId}`, JSON.stringify(v)),
};
```

---

## 3. PC Extension Implementation (`src/.../settings_modal.js`)

### 3.1 UI Additions
*   In the "Sync" tab, below the Connection Status.
*   Add a Button: `ðŸ“± Generate Mobile Link`.

### 3.2 logic
1.  **Get Current Settings**: `url`, `token`, `vocabService.currentProfileId`.
2.  **Payload Generation**:
    ```javascript
    const payload = JSON.stringify({ u: url, t: token, p: profileId });
    const b64 = btoa(payload);
    const link = `https://aidu-mobile.pages.dev/?conf=${b64}`;
    ```
3.  **Action**:
    *   **Copy to Clipboard**: `navigator.clipboard.writeText(link)`.
    *   **Toast**: "Link copied! Send to your phone to configure instantly.".

---

## 4. Execution Steps for Gemini 3
1.  **Mobile**: Modify `mobile/app.js` to add the `init` interception logic.
2.  **Extension**: Modify `settings_modal.js` to add the generator button.
3.  **Build**: Run `npm run build` && `npm run deploy:frontend`.
