{
  "version": 3,
  "sources": ["../worker.js"],
  "sourceRoot": "out2",
  "sourcesContent": ["export default {\r\n    async fetch(request, env, ctx) {\r\n        const corsHeaders = {\r\n            \"Access-Control-Allow-Origin\": \"*\",\r\n            \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\r\n            \"Access-Control-Allow-Headers\": \"Content-Type, X-Install-ID\",\r\n        };\r\n\r\n        if (request.method === \"OPTIONS\") {\r\n            return new Response(null, { headers: corsHeaders });\r\n        }\r\n\r\n        if (request.method !== \"POST\") {\r\n            return new Response(\"Method Not Allowed\", { status: 405 });\r\n        }\r\n\r\n        const installId = request.headers.get(\"X-Install-ID\");\r\n        if (!installId) {\r\n            return new Response(\"Unauthorized: Missing Install ID\", { status: 401, headers: corsHeaders });\r\n        }\r\n\r\n        // --- Rate Limiting Logic (KV) ---\r\n        const now = Date.now();\r\n        const minuteKey = `min:${installId}:${Math.floor(now / 60000)}`;\r\n        const dayKey = `day:${installId}:${new Date().toISOString().split('T')[0]}`;\r\n\r\n        // Per-minute check (Max 5)\r\n        const minCount = parseInt(await env.AIDU_LIMITS.get(minuteKey) || \"0\");\r\n        if (minCount >= 5) {\r\n            return new Response(JSON.stringify({\r\n                error: \"RATE_LIMIT_EXCEEDED\",\r\n                message: \"\u26A0\uFE0F \u8C03\u7528\u592A\u9891\u7E41\u4E86\uFF01\u516C\u5171\u8282\u70B9\u6BCF\u5206\u949F\u9650 5 \u6B21\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\uFF0C\u6216\u5728\u8BBE\u7F6E\u4E2D\u586B\u5165\u60A8\u81EA\u5DF1\u7684 API Key \u4EE5\u901A\u8FC7\u79C1\u6709\u901A\u9053\u8BBF\u95EE\u3002\"\r\n            }), { status: 429, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } });\r\n        }\r\n\r\n        // Per-day check (Max 50)\r\n        const dayCount = parseInt(await env.AIDU_LIMITS.get(dayKey) || \"0\");\r\n        if (dayCount >= 50) {\r\n            return new Response(JSON.stringify({\r\n                error: \"DAILY_LIMIT_EXCEEDED\",\r\n                message: \"\u4ECA\u65E5\u514D\u8D39\u989D\u5EA6\u5DF2\u7528\u5B8C (50/50)\u3002\u516C\u5171\u8282\u70B9\u8D44\u6E90\u6709\u9650\uFF0C\u5EFA\u8BAE\u5728\u63D2\u4EF6\u8BBE\u7F6E\u4E2D\u586B\u5165\u60A8\u81EA\u5DF1\u7684 API Key \u4EE5\u89E3\u9501\u65E0\u9650\u989D\u5EA6\u3002\"\r\n            }), { status: 429, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } });\r\n        }\r\n\r\n        // Update Counters\r\n        ctx.waitUntil(env.AIDU_LIMITS.put(minuteKey, (minCount + 1).toString(), { expirationTtl: 120 }));\r\n        ctx.waitUntil(env.AIDU_LIMITS.put(dayKey, (dayCount + 1).toString(), { expirationTtl: 172800 })); // 48h safety\r\n\r\n        try {\r\n            const body = await request.json();\r\n            const { provider, payload } = body;\r\n\r\n            if (provider === \"zhipu\" || provider === \"glm\") {\r\n                return handleZhipu(payload, env.ZHIPU_API_KEY, corsHeaders);\r\n            }\r\n\r\n            return new Response(\"Unsupported Provider\", { status: 400, headers: corsHeaders });\r\n        } catch (err) {\r\n            return new Response(err.message, { status: 500, headers: corsHeaders });\r\n        }\r\n    }\r\n};\r\n\r\nasync function handleZhipu(payload, apiKey, corsHeaders) {\r\n    const url = \"https://open.bigmodel.cn/api/paas/v4/chat/completions\";\r\n\r\n    const response = await fetch(url, {\r\n        method: \"POST\",\r\n        headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Authorization\": `Bearer ${apiKey}`\r\n        },\r\n        body: JSON.stringify(payload)\r\n    });\r\n\r\n    const data = await response.json();\r\n    return new Response(JSON.stringify(data), {\r\n        headers: {\r\n            ...corsHeaders,\r\n            \"Content-Type\": \"application/json\"\r\n        }\r\n    });\r\n}\r\n"],
  "mappings": ";;;;AAAA,IAAO,iBAAQ;AAAA,EACX,MAAM,MAAM,SAAS,KAAK,KAAK;AAC3B,UAAM,cAAc;AAAA,MAChB,+BAA+B;AAAA,MAC/B,gCAAgC;AAAA,MAChC,gCAAgC;AAAA,IACpC;AAEA,QAAI,QAAQ,WAAW,WAAW;AAC9B,aAAO,IAAI,SAAS,MAAM,EAAE,SAAS,YAAY,CAAC;AAAA,IACtD;AAEA,QAAI,QAAQ,WAAW,QAAQ;AAC3B,aAAO,IAAI,SAAS,sBAAsB,EAAE,QAAQ,IAAI,CAAC;AAAA,IAC7D;AAEA,UAAM,YAAY,QAAQ,QAAQ,IAAI,cAAc;AACpD,QAAI,CAAC,WAAW;AACZ,aAAO,IAAI,SAAS,oCAAoC,EAAE,QAAQ,KAAK,SAAS,YAAY,CAAC;AAAA,IACjG;AAGA,UAAM,MAAM,KAAK,IAAI;AACrB,UAAM,YAAY,OAAO,SAAS,IAAI,KAAK,MAAM,MAAM,GAAK,CAAC;AAC7D,UAAM,SAAS,OAAO,SAAS,KAAI,oBAAI,KAAK,GAAE,YAAY,EAAE,MAAM,GAAG,EAAE,CAAC,CAAC;AAGzE,UAAM,WAAW,SAAS,MAAM,IAAI,YAAY,IAAI,SAAS,KAAK,GAAG;AACrE,QAAI,YAAY,GAAG;AACf,aAAO,IAAI,SAAS,KAAK,UAAU;AAAA,QAC/B,OAAO;AAAA,QACP,SAAS;AAAA,MACb,CAAC,GAAG,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE,CAAC;AAAA,IACxF;AAGA,UAAM,WAAW,SAAS,MAAM,IAAI,YAAY,IAAI,MAAM,KAAK,GAAG;AAClE,QAAI,YAAY,IAAI;AAChB,aAAO,IAAI,SAAS,KAAK,UAAU;AAAA,QAC/B,OAAO;AAAA,QACP,SAAS;AAAA,MACb,CAAC,GAAG,EAAE,QAAQ,KAAK,SAAS,EAAE,GAAG,aAAa,gBAAgB,mBAAmB,EAAE,CAAC;AAAA,IACxF;AAGA,QAAI,UAAU,IAAI,YAAY,IAAI,YAAY,WAAW,GAAG,SAAS,GAAG,EAAE,eAAe,IAAI,CAAC,CAAC;AAC/F,QAAI,UAAU,IAAI,YAAY,IAAI,SAAS,WAAW,GAAG,SAAS,GAAG,EAAE,eAAe,OAAO,CAAC,CAAC;AAE/F,QAAI;AACA,YAAM,OAAO,MAAM,QAAQ,KAAK;AAChC,YAAM,EAAE,UAAU,QAAQ,IAAI;AAE9B,UAAI,aAAa,WAAW,aAAa,OAAO;AAC5C,eAAO,YAAY,SAAS,IAAI,eAAe,WAAW;AAAA,MAC9D;AAEA,aAAO,IAAI,SAAS,wBAAwB,EAAE,QAAQ,KAAK,SAAS,YAAY,CAAC;AAAA,IACrF,SAAS,KAAK;AACV,aAAO,IAAI,SAAS,IAAI,SAAS,EAAE,QAAQ,KAAK,SAAS,YAAY,CAAC;AAAA,IAC1E;AAAA,EACJ;AACJ;AAEA,eAAe,YAAY,SAAS,QAAQ,aAAa;AACrD,QAAM,MAAM;AAEZ,QAAM,WAAW,MAAM,MAAM,KAAK;AAAA,IAC9B,QAAQ;AAAA,IACR,SAAS;AAAA,MACL,gBAAgB;AAAA,MAChB,iBAAiB,UAAU,MAAM;AAAA,IACrC;AAAA,IACA,MAAM,KAAK,UAAU,OAAO;AAAA,EAChC,CAAC;AAED,QAAM,OAAO,MAAM,SAAS,KAAK;AACjC,SAAO,IAAI,SAAS,KAAK,UAAU,IAAI,GAAG;AAAA,IACtC,SAAS;AAAA,MACL,GAAG;AAAA,MACH,gBAAgB;AAAA,IACpB;AAAA,EACJ,CAAC;AACL;AAnBe;",
  "names": []
}
